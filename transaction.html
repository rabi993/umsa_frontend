<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaction Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link
      href="https://cdn.jsdelivr.net/npm/swiffy-slider@1.6.0/dist/css/swiffy-slider.min.css"
      rel="stylesheet"
      crossorigin="anonymous"
    />
  
  <link rel="stylesheet" href="style.css">
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 10px;
            text-align: left;
        }
        #transactionForm {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <nav  class="navbar navbar-expand-lg  py-3 fixed-top ">
        <div class="container-fluid container">
            <a class="navbar-brand lgo " href="index.html">
                <img src="./images/umsal.png" alt="Logo" width="50" height="50" class="d-inline-block align-text-top ">
                UMSA
              </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse " id="navbarNavDropdown">
            <ul class="navbar-nav justify-content-center w-100 gap-2">
              <li class="nav-item">
                <a class="nav-link "  href="index.html">Home</a>
              </li>
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle aut_menu4" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                  Posts
                </a>
                <ul class="dropdown-menu">
                  <li><a class="dropdown-item ndropdown-item" href="allposts.html">Posts</a></li>
                  <li><a class="dropdown-item ndropdown-item" href="allEvent.html">Upcoming Events</a></li>
                  <li><a class="dropdown-item ndropdown-item" href="allNotice.html">Notice</a></li>
                </ul>
              </li>
              <li class="nav-item ">
                <a class="nav-link aut_menu3 bg-secondary" href="transaction.html">Donate</a>
              </li>
              <li class="nav-item">
                <a class="nav-link aut_menu2" href="blood.html">Blood</a>
              </li>
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                  About Us
                </a>
                <ul class="dropdown-menu">
                  <li><a class="dropdown-item ndropdown-item" href="contactus.html">About Us</a></li>
                  <li><a class="dropdown-item ndropdown-item" href="service.html">Services</a></li>
                  <li><a class="dropdown-item ndropdown-item" href="contactus.html">Contact Us</a></li>
                </ul>
              </li>
              <li class="nav-item ">
                <a class="nav-link aut_menu1" href="people.html">Members</a>
              </li>
              <li class="nav-item">
                <a class="nav-link aut_menu" href="account.html">Exchequer</a>
              </li>
            </ul>  
            <ul  class=" navbar-nav ms-auto gap-2">
                <li class="nav-item">
                    <a class="nav-link sign-menu " href="registration.html">Sign_Up</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link login-menu " href="login.html">Login</a>
                </li>
                <li class="nav-item">
                    <a class=" nav-link profile-menu d-none" href="profile.html">Profile</a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link logout-menu d-none" onclick="handlelogOut()" href="#" >Logout</a>
                </li>
            </ul>
          </div>
          
        </div>
      </nav>
      <h1 style="padding-top: 130px;" class="text-center">Latest Exchequer!</h1>
  <table class="container" id="accountTable">
    <thead>
      <tr>
        <th>Total Credit</th>
        <th>Total Debit</th>
        <th>Final Cash</th>
        <th>Created At</th>
        <th>Updated At</th>
      </tr>
    </thead>
    <tbody>
      <!-- Dynamic rows will be injected here -->
    </tbody>
  </table>

  
    <h1 style="padding-top: 130px;" class="text-center">All Transaction List</h1>
    <table class="container" id="transactionTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>TRX_ID</th>
                <th>User_ID</th>
                <th>Username</th>
                <th>fullname</th>
                <th>Reference</th>
                <th>Amount</th>
                <th>Type</th>
                <th>Source</th>
                <th>Media</th>
                <th>Purpose</th>
                <th>Comment</th>
                <th>created_at</th>
                <th>updated_at</th>
                <th>Approved</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
    <h1 class="text-center">My Transaction List</h1>
    <table class="container" id="myTransactionTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>TRX_ID</th>
                <th>User_ID</th>
                <th>Username</th>
                <th>fullname</th>
                <th>Reference</th>
                <th>Amount</th>
                <th>Type</th>
                <th>Source</th>
                <th>Media</th>
                <th>Purpose</th>
                <th>Comment</th>
                <th>created_at</th>
                <th>updated_at</th>
                <th>Approved</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <h2 class="text-center">Add Donate</h2>
    <form class="text-center " id="transactionForm">
        <input type="hidden" id="transactionId">
        <label>TRX ID: <input type="text" id="trxId" required></label><br>
        <label>Reference: <input type="text" id="reference"></label><br>
        <label>Amount: <input type="number" id="amount" required></label><br>
        <input type="hidden" id="typys" value="credit">
        <!-- <label>Type: 
            <select id="typys" required>
                <option value="credit">Credit</option>
                <option value="debit">Debit</option>
            </select>
        </label><br> -->
        <label>Source: <input type="text" id="sourcePeople"></label><br>
        <label>Media: <input type="text" id="media"></label><br>
        <label>Purpose: <input type="text" id="purpose"></label><br>
        <label>Comment: <input type="text" id="comment"></label><br>
        <!-- <label>Approved: 
            <input type="checkbox " id="approved">
        </label><br> -->
        
        <input type="hidden" id="approved">
        
        <button type="submit">Save</button>
    </form>

    <script>
        
        const apiUrl = "http://127.0.0.1:8000/transaction/";
        const apiUrlUser = "http://127.0.0.1:8000/users/";

        function fetchTransactions() {
            fetch(apiUrl)
                .then(response => response.json())
                .then(transactions => {
                    const tableBody = document.querySelector("#transactionTable tbody");
                    tableBody.innerHTML = ""; // Clear table

                    transactions.forEach(transaction => {
                        // Fetch user details for each transaction
                        fetch(`${apiUrlUser}${transaction.user}/`)
                            .then(response => response.json())
                            .then(user => {
                                // Extract username and fullname
                                const username = user.username || "N/A";
                                const first_name = user.first_name || "N/A";
                                const last_name = user.last_name || "N/A";

                                // Create a row for the transaction
                                const row = `
                                    <tr>
                                        <td>${transaction.id}</td>
                                        <td>${transaction.trx_id}</td>
                                        <td>${transaction.user}</td>
                                        <td>${username}</td>
                                        <td>${first_name} ${last_name}</td>
                                        <td>${transaction.reference || ''}</td>
                                        <td>${transaction.amount}</td>
                                        <td>${transaction.typys}</td>
                                        <td>${transaction.source_people || ''}</td>
                                        <td>${transaction.media || ''}</td>
                                        <td>${transaction.purpose || ''}</td>
                                        <td>${transaction.comment || ''}</td>
                                        <td>${transaction.created_at || ''}</td>
                                        <td>${transaction.updated_at || ''}</td>
                                        <td>${transaction.approved ? "Yes" : "No"}</td>
                                    </tr>
                                `;

                                // Append the row to the table
                                tableBody.insertAdjacentHTML("beforeend", row);
                            })
                            .catch(error => {
                                console.error(`Error fetching user details for user ID ${transaction.user}:`, error);
                            });
                    });
                })
                .catch(error => {
                    console.error("Error fetching transactions:", error);
                });
        }
        function fetchTransactions1() {
            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.querySelector("#myTransactionTable tbody");
                    tableBody.innerHTML = ""; // Clear table

                    // Get the logged-in user ID from localStorage
                    const loggedInUserId = localStorage.getItem("user_id");
                    console.log("Logged-in user ID:", loggedInUserId);

                    // Check if loggedInUserId exists
                    if (!loggedInUserId) {
                        console.error("No logged-in user found!");
                        return;
                    }

                    let userFound = false;

                    // Iterate over the transactions
                    data.forEach(transaction => {
                        // Adjust this based on the structure of the 'user' field
                        const transactionUserId = transaction.user.id || transaction.user;
                         

                        if (transactionUserId === parseInt(loggedInUserId)) {
                            userFound = true;

                            fetch(`${apiUrlUser}${transaction.user}/`)
                                .then(response => response.json())
                                .then(user => {
                                    // Extract username and fullname
                                    const username = user.username || "N/A";
                                    const first_name = user.first_name || "N/A";
                                    const last_name = user.last_name || "N/A";

                                    // Create a row for the transaction
                                    const row = `
                                        <tr>
                                            <td>${transaction.id}</td>
                                            <td>${transaction.trx_id}</td>
                                            <td>${transaction.user}</td>
                                            <td>${username}</td>
                                            <td>${first_name} ${last_name}</td>
                                            <td>${transaction.reference || ''}</td>
                                            <td>${transaction.amount}</td>
                                            <td>${transaction.typys}</td>
                                            <td>${transaction.source_people || ''}</td>
                                            <td>${transaction.media || ''}</td>
                                            <td>${transaction.purpose || ''}</td>
                                            <td>${transaction.comment || ''}</td>
                                            <td>${transaction.created_at || ''}</td>
                                            <td>${transaction.updated_at || ''}</td>
                                            <td>${transaction.approved ? "Yes" : "No"}</td>
                                        </tr>
                                    `;

                                    // Append the row to the table
                                    tableBody.insertAdjacentHTML("beforeend", row);
                                })
                                .catch(error => {
                                    console.error(`Error fetching user details for user ID ${transaction.user}:`, error);
                                });                                                       
                        }
                    });

                    if (!userFound) {
                        tableBody.innerHTML = `<tr><td colspan="13">No transactions found for your account.</td></tr>`;
                    }
                })
                .catch(error => {
                    console.error("Error fetching transactions:", error);
                });
        }

        


        // Add or edit a transaction
        document.getElementById("transactionForm").addEventListener("submit", function(event) {
            event.preventDefault();
            const id = document.getElementById("transactionId").value;
            const method = id ? "PUT" : "POST";
            const url = id ? `${apiUrl}${id}/` : apiUrl;

            const transactionData = {
                user: localStorage.getItem("user_id"),
                trx_id: document.getElementById("trxId").value,
                reference: document.getElementById("reference").value,
                amount: document.getElementById("amount").value,
                typys: document.getElementById("typys").value,
                source_people: document.getElementById("sourcePeople").value,
                media: document.getElementById("media").value,
                purpose: document.getElementById("purpose").value,
                comment: document.getElementById("comment").value,
                approved: document.getElementById("approved").checked
            };

            fetch(url, {
                method: method,
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(transactionData),
            })
            .then(response => {
                if (response.ok) {
                    fetchTransactions();
                    document.getElementById("transactionForm").reset();
                }
            });
        });
        // Initial fetch
        fetchTransactions();
        fetchTransactions1();
    </script>
    <script>
        // Fetch account data and populate the table
        async function fetchAccounts() {
          const response = await fetch('http://127.0.0.1:8000/account/');
          const data = await response.json();
    
          const tableBody = document.getElementById('accountTable').querySelector('tbody');
          tableBody.innerHTML = ''; // Clear the table body before adding rows
    
          data.forEach(account => {
            const row = document.createElement('tr');
            
            row.innerHTML = `
              <td>${account.total_credit}</td>
              <td>${account.total_debit}</td>
              <td>${account.final_cash}</td>
              <td>${new Date(account.created_at).toLocaleString()}</td>
              <td>${new Date(account.updated_at).toLocaleString()}</td>
        
            `;
    
            tableBody.appendChild(row);
          });
        }
    
        // Fetch accounts on page load
        fetchAccounts();
      </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="./logout.js"></script>
    <script src="index.js"></script>
</body>
</html>
