
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profile</title>
    
    <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="..."
    />
    <link
      href="https://cdn.jsdelivr.net/npm/swiffy-slider@1.6.0/dist/css/swiffy-slider.min.css"
      rel="stylesheet"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="style.css" />

    <style>
      .profile-card {
        max-width: 500px;
        margin: 50px auto;
        padding: 20px;
        border: 1px solid #ccc;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        background: #f9f9f9;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="container my-5">
        <div class="d-flex justify-content-center gap-3 my-3">
          <a target="" class="text-white text-decoration-none btn btn-info border rounded p-2" href="changepass.html">Change Password</a>
          <a target="" class="text-white text-decoration-none btn btn-secondary border rounded p-2" href="updateProfile.html">Update Your Profile</a>
        </div>
        <div id="user-card-container" class="d-flex justify-content-center"></div>
      </div>

      <h3 class="text-center"><b>Your All Donation History </b></h3>
      <hr class="container">

      <div class="container my-3 text-center ">
        
        <table id="myTransactionTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>TRX_ID</th>
                    <th>User_ID</th>
                    <th>Username</th>
                    <th>fullname</th>
                    <th>Reference</th>
                    <th>Amount</th>
                    <th>Type</th>
                    <th>Source</th>
                    <th>Media</th>
                    <th>Purpose</th>
                    <th>Comment</th>
                    <th>created_at</th>
                    <th>updated_at</th>
                    <th>Approved</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>

        <h2>Donate</h2>
        <form id="transactionForm">
            <input type="hidden" id="transactionId">
            <label>TRX ID: <input type="text" id="trxId" required></label><br>
            <label>Reference: <input type="text" id="reference"></label><br>
            <label>Amount: <input type="number" id="amount" required></label><br>
            <input type="hidden" id="typys" value="credit">
            <!-- <label>Type: 
                <select id="typys" required>
                    <option value="credit">Credit</option>
                    <option value="debit">Debit</option>
                </select>
            </label><br> -->
            <label>Source: <input type="text" id="sourcePeople"></label><br>
            <label>Media: <input type="text" id="media"></label><br>
            <label>Purpose: <input type="text" id="purpose"></label><br>
            <label>Comment: <input type="text" id="comment"></label><br>
            <!-- <label>Approved: 
                <input type="checkbox " id="approved">
            </label><br> -->
            
            <input type="hidden" id="approved">
            
            <button type="submit">Save</button>
        </form>
      </div>
    </header>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/swiffy-slider@1.6.0/dist/js/swiffy-slider.min.js"
      crossorigin="anonymous"
      defer
    ></script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.js"></script>
    <script>
      // Fetch and display user and people data in a card
      document.addEventListener("DOMContentLoaded", function () {
        const userId = localStorage.getItem('user_id'); // Get the user ID from local storage

        // Fetch the list of people and find the relevant person for the user
        fetch("http://127.0.0.1:8000/people/list/")
          .then((response) => {
            if (!response.ok) {
              throw new Error("Error fetching people list");
            }
            return response.json();
          })
          .then((peoples) => {
            const person = peoples.find((p) => p.user == userId);
            localStorage.setItem("people_id", person.id);
            if (!person) {
              throw new Error("No associated person found for the user");
            }
            return person;
          })
          .then((person) => {
            const userApiUrl = `http://127.0.0.1:8000/users/${userId}`;
            const peopleApiUrl = `http://127.0.0.1:8000/people/list/${person.id}`;
            const cardContainer = document.getElementById("user-card-container");

            // Fetch user and people data in parallel
            Promise.all([fetch(userApiUrl), fetch(peopleApiUrl)])
              .then(async ([userResponse, peopleResponse]) => {
                if (!userResponse.ok || !peopleResponse.ok) {
                  throw new Error("Error fetching user or people data");
                }
                const user = await userResponse.json();
                const people = await peopleResponse.json();

                // Create the card element
                const card = document.createElement("div");
                card.className = "card p-3 shadow-lg";
                card.style.width = "25rem";

                // Populate the card with user and people details
                card.innerHTML = `
                  <div class="card-body">
                    <h5 class="card-title text-center">${user.first_name || "N/A"} ${user.last_name || "N/A"}'s Profile</h5>
                    <div class="card-text w-25 m-auto">
                      ${
                        people.image
                          ? `<img src="${people.image}" alt="Profile Image" class="img-fluid rounded mt-2" style="max-height: 200px;">`
                          : "<p class='text-muted'>No image available</p>"
                      }
                    </div>
                    <h6 class="mt-3">User Details:</h6>
                    <p class="card-text"><strong>ID:</strong> ${user.id}</p>
                    <p class="card-text"><strong>Username:</strong> ${user.username}</p>
                    <p class="card-text"><strong>First Name:</strong> ${user.first_name || "N/A"}</p>
                    <p class="card-text"><strong>Last Name:</strong> ${user.last_name || "N/A"}</p>
                    <p class="card-text"><strong>Email:</strong> ${user.email}</p>
                    <p class="card-text"><strong>Role:</strong> ${user.is_superuser ? "Admin/Superuser" : "User"}</p>
                    
                    <h6 class="mt-3">Profile Details:</h6>
                    <p class="card-text"><strong>Profile ID:</strong> ${people.id}</p>
                    <p class="card-text"><strong>Mobile:</strong> ${people.mobile_no || "N/A"}</p>
                    <p class="card-text"><strong>Village:</strong> ${people.village || "N/A"}</p>
                    <p class="card-text"><strong>Union:</strong> ${people.union || "N/A"}</p>
                    <p class="card-text"><strong>Ward:</strong> ${people.word || "N/A"}</p>
                    <p class="card-text"><strong>City:</strong> ${people.livesIn || "N/A"}</p>
                    <p class="card-text"><strong>Date of Birth:</strong> ${people.birth_date || "N/A"}</p>
                    <p class="card-text"><strong>Blood Group:</strong> ${people.blood_group || "N/A"}</p>
                    <p class="card-text"><strong>Last Donation:</strong> ${people.last_blood_donate_date || "N/A"}</p>
                    <p class="card-text"><strong>Next Eligible Donation:</strong> ${people.available_for_donate_date || "N/A"}</p>
                    <p class="card-text"><strong>Marital Status:</strong> ${people.marital_status || "N/A"}</p>
                    <p class="card-text"><strong>Job Title:</strong> ${people.designation || "N/A"}</p>
                    <p class="card-text"><strong>Works_at:</strong> ${people.worksat || "N/A"}</p>
                    <p class="card-text"><strong>University:</strong> ${people.varsity || "N/A"}</p>
                    <p class="card-text"><strong>Subject:</strong> ${people.subject || "N/A"}</p>
                    <p class="card-text"><strong>Session:</strong> ${people.session || "N/A"}</p>
                    <p class="card-text"><strong>Edu Complete:</strong> ${people.complete ? "Yes" : "No"}</p>
                    <p class="card-text"><strong>CV:</strong> <a href="${people.cv}" target="_blank">Download CV</a></p>
                    <p class="card-text"><strong>Association Post:</strong> ${people.association_post || "N/A"}</p>
                  </div>

                `;

                // Append the card to the container
                cardContainer.appendChild(card);
              })
              .catch((error) => {
                console.error("Error fetching user or people details:", error);
                const errorMessage = document.createElement("p");
                errorMessage.textContent = "Failed to load user or people details.";
                cardContainer.appendChild(errorMessage);
              });
          })
          .catch((error) => {
            console.error("Error finding person for user:", error);
          });
      });
    </script>
    <script>
        
      const apiUrl = "http://127.0.0.1:8000/transaction/";
      const apiUrlUser = "http://127.0.0.1:8000/users/";

       
      function fetchTransactions1() {
          fetch(apiUrl)
              .then(response => response.json())
              .then(data => {
                  const tableBody = document.querySelector("#myTransactionTable tbody");
                  tableBody.innerHTML = ""; // Clear table

                  // Get the logged-in user ID from localStorage
                  const loggedInUserId = localStorage.getItem("user_id");
                  console.log("Logged-in user ID:", loggedInUserId);

                  // Check if loggedInUserId exists
                  if (!loggedInUserId) {
                      console.error("No logged-in user found!");
                      return;
                  }

                  let userFound = false;

                  // Iterate over the transactions
                  data.forEach(transaction => {
                      // Adjust this based on the structure of the 'user' field
                      const transactionUserId = transaction.user.id || transaction.user;
                       

                      if (transactionUserId === parseInt(loggedInUserId)) {
                          userFound = true;

                          fetch(`${apiUrlUser}${transaction.user}/`)
                              .then(response => response.json())
                              .then(user => {
                                  // Extract username and fullname
                                  const username = user.username || "N/A";
                                  const first_name = user.first_name || "N/A";
                                  const last_name = user.last_name || "N/A";

                                  // Create a row for the transaction
                                  const row = `
                                      <tr>
                                          <td>${transaction.id}</td>
                                          <td>${transaction.trx_id}</td>
                                          <td>${transaction.user}</td>
                                          <td>${username}</td>
                                          <td>${first_name} ${last_name}</td>
                                          <td>${transaction.reference || ''}</td>
                                          <td>${transaction.amount}</td>
                                          <td>${transaction.typys}</td>
                                          <td>${transaction.source_people || ''}</td>
                                          <td>${transaction.media || ''}</td>
                                          <td>${transaction.purpose || ''}</td>
                                          <td>${transaction.comment || ''}</td>
                                          <td>${transaction.created_at || ''}</td>
                                          <td>${transaction.updated_at || ''}</td>
                                          <td>${transaction.approved ? "Yes" : "No"}</td>
                                      </tr>
                                  `;

                                  // Append the row to the table
                                  tableBody.insertAdjacentHTML("beforeend", row);
                              })
                              .catch(error => {
                                  console.error(`Error fetching user details for user ID ${transaction.user}:`, error);
                              });                                                       
                      }
                  });

                  if (!userFound) {
                      tableBody.innerHTML = `<tr><td colspan="13">No transactions found for your account.</td></tr>`;
                  }
              })
              .catch(error => {
                  console.error("Error fetching transactions:", error);
              });
      }

      


      // Add or edit a transaction
      document.getElementById("transactionForm").addEventListener("submit", function(event) {
          event.preventDefault();
          const id = document.getElementById("transactionId").value;
          const method = id ? "PUT" : "POST";
          const url = id ? `${apiUrl}${id}/` : apiUrl;

          const transactionData = {
              user: localStorage.getItem("user_id"),
              trx_id: document.getElementById("trxId").value,
              reference: document.getElementById("reference").value,
              amount: document.getElementById("amount").value,
              typys: document.getElementById("typys").value,
              source_people: document.getElementById("sourcePeople").value,
              media: document.getElementById("media").value,
              purpose: document.getElementById("purpose").value,
              comment: document.getElementById("comment").value,
              approved: document.getElementById("approved").checked
          };

          fetch(url, {
              method: method,
              headers: {
                  "Content-Type": "application/json",
              },
              body: JSON.stringify(transactionData),
          })
          .then(response => {
              if (response.ok) {
                  fetchTransactions();
                  document.getElementById("transactionForm").reset();
              }
          });
      });
      // Initial fetch
      
      fetchTransactions1();
  </script>
  </body>
</html>
